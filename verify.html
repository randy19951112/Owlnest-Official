<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Token Verify | Owlnest</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Manrope"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
          colors: { brand: { dark: '#455169', cream: '#faefcf', gold: '#D4AF37' } }
        }
      }
    }
  </script>
</head>

<body class="bg-brand-dark text-white min-h-screen flex flex-col font-sans relative">

  <header class="py-6 px-8 flex justify-center border-b border-white/5 relative z-10 bg-brand-dark/50 backdrop-blur-md">
    <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition">
      <img src="logo2.png" alt="Owlnest Logo" class="h-10 w-auto brightness-200 contrast-100">
      <span class="font-serif text-2xl tracking-widest font-bold">Owlnest</span>
    </a>
  </header>

  <main class="flex-grow flex items-center justify-center p-4 relative z-10">
    <div class="bg-white/5 border border-white/10 p-10 rounded-lg backdrop-blur-xl shadow-2xl w-full max-w-lg text-center">

      <div class="w-16 h-16 bg-brand-gold rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-brand-gold/20">
        <i class="fas fa-shield-alt text-brand-dark text-3xl"></i>
      </div>

      <h2 class="text-3xl font-serif mb-2 text-brand-gold">Token Check</h2>
      <p class="mb-8 text-sm text-gray-400 font-light">
        Enter your 12-character Activation Token to verify authenticity.
      </p>

      <input
        type="text"
        id="verify-code"
        placeholder="ENTER 12-CHAR TOKEN"
        class="w-full p-4 rounded bg-brand-dark/50 border border-brand-gold/30 text-white placeholder-gray-500 focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold transition text-center tracking-widest font-mono mb-3"
        autocomplete="off" autocapitalize="off" spellcheck="false"
      />

      <div id="hint" class="text-xs text-gray-400 mb-6">Tip: paste the token exactly as provided (A–Z / 0–9, 12 characters).</div>

      <button
        id="verify-btn"
        class="w-full bg-brand-cream text-brand-dark font-bold py-4 rounded hover:bg-white transition duration-300 uppercase tracking-widest text-sm shadow-lg mb-6"
      >
        Verify Now
      </button>

      <!-- Result Area -->
      <div id="result-area" class="hidden text-left bg-black/30 rounded p-6 border border-white/5 animate-fade-in">
        <div class="flex items-start gap-4">
          <div id="status-icon" class="text-2xl mt-1"></div>
          <div>
            <p id="result-status" class="font-bold text-lg mb-1"></p>
            <p id="result-msg" class="text-sm text-gray-400 mb-4 leading-relaxed"></p>
          </div>
        </div>

        <a
          id="activate-link"
          href="#"
          class="block text-center bg-brand-gold text-brand-dark py-3 rounded font-bold text-sm uppercase tracking-wide hover:bg-white transition hidden mt-2"
        >
          Activate & Register
        </a>
      </div>
    </div>
  </main>

  <footer class="py-8 text-center text-xs text-gray-500 relative z-10">
    <div class="flex justify-center items-center gap-6 mb-4">
      <a href="https://facebook.com/owlnestofficial" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-facebook-f text-lg"></i></a>
      <a href="https://www.instagram.com/owlnestpq_chilllife" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-instagram text-lg"></i></a>
      <a href="http://x.com/owlnestpq_2025" target="_blank" class="hover:text-brand-gold transition flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 fill-current" viewBox="0 0 512 512">
          <path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/>
        </svg>
      </a>
    </div>
    <a href="index.html" class="hover:text-brand-gold transition border-b border-transparent hover:border-brand-gold pb-0.5">Back to Home</a>
    <p class="mt-4">&copy; 2025 Owlnest Official. All Rights Reserved.</p>
  </footer>

  <script>
    const inputEl = document.getElementById("verify-code");
    const btn = document.getElementById("verify-btn");
    const hintEl = document.getElementById("hint");

    const resultArea = document.getElementById("result-area");
    const statusEl = document.getElementById("result-status");
    const msgEl = document.getElementById("result-msg");
    const iconEl = document.getElementById("status-icon");
    const actLink = document.getElementById("activate-link");

    function setLoading(isLoading) {
      btn.disabled = isLoading;
      btn.classList.toggle("opacity-50", isLoading);
      btn.textContent = isLoading ? "Verifying..." : "Verify Now";
    }

    function normalizeToken(raw) {
      const s = String(raw || "").trim();
      if (!s) return "";

      // 相容：若有人貼 serial.token，取最後一段
      const dot = s.lastIndexOf(".");
      const token = (dot >= 0 ? s.slice(dot + 1) : s).trim().toUpperCase();
      return token;
    }

    function updateHint() {
      const t = normalizeToken(inputEl.value);
      if (!t) {
        hintEl.textContent = "Tip: paste the token exactly as provided (A–Z / 0–9, 12 characters).";
        return;
      }
      if (t.length !== 12) {
        hintEl.textContent = `Token length: ${t.length}/12`;
        return;
      }
      hintEl.textContent = "Looks good. Click Verify Now.";
    }

    function showResult({ ok, activated, message, token }) {
      resultArea.classList.remove("hidden");
      actLink.classList.add("hidden");

      if (ok) {
        statusEl.textContent = "Genuine Token";
        statusEl.className = "font-bold text-lg mb-1 text-green-400";
        iconEl.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';

        if (activated) {
          msgEl.textContent = message || "This product is already activated and registered to an account.";
        } else {
          msgEl.textContent = message || "This token is valid and has not been activated yet. Register it now to claim ownership.";
          const t = normalizeToken(token || inputEl.value);
          // ✅ 兼容：同時帶 token 與 key（以免你的 activate.html 還在讀 key）
          actLink.href = `activate.html?token=${encodeURIComponent(t)}&key=${encodeURIComponent(t)}`;
          actLink.classList.remove("hidden");
        }
      } else {
        statusEl.textContent = "Verification Failed";
        statusEl.className = "font-bold text-lg mb-1 text-red-400";
        iconEl.innerHTML = '<i class="fas fa-times-circle text-red-400"></i>';
        msgEl.textContent = message || "We could not verify this token. It may be invalid, counterfeit, or revoked.";
      }
    }

    // URL 自動填入：?token= 或 ?key=
    (function autoFillFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const urlToken = params.get("token") || params.get("key");
      if (urlToken) inputEl.value = String(urlToken);
      updateHint();
    })();

    inputEl.addEventListener("input", () => {
      const before = inputEl.value;
      const after = before.toUpperCase();
      if (before !== after) inputEl.value = after;
      updateHint();
    });

    async function verifyProduct() {
      const token = normalizeToken(inputEl.value);
      if (!token) return;

      if (token.length !== 12 || !/^[A-Z0-9]{12}$/.test(token)) {
        showResult({ ok: false, activated: false, message: "Invalid token format. Please enter exactly 12 letters/numbers." });
        return;
      }

      setLoading(true);
      resultArea.classList.add("hidden");
      actLink.classList.add("hidden");

      try {
        const res = await fetch("/.netlify/functions/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, key: token })
        });

        const rawText = await res.text();
        let data = {};
        try { data = JSON.parse(rawText); } catch (_) { data = { message: rawText }; }

        const valid = !!(data.valid ?? data.ok ?? data.isValid);
        const activated = !!(data.activated ?? data.isActivated);
        const message = data.message || data.msg || (data.error ? String(data.error) : "");
        const tokenOut = data.token || token;

        if (!res.ok && !message) {
          showResult({ ok: false, activated: false, message: `Verify API error (${res.status})` });
          return;
        }

        showResult({ ok: valid, activated, message: message || undefined, token: tokenOut });

      } catch (err) {
        console.error(err);
        showResult({ ok: false, activated: false, message: "Service unavailable. Please try again later." });
      } finally {
        setLoading(false);
      }
    }

    btn.addEventListener("click", verifyProduct);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") verifyProduct();
    });

    updateHint();
  </script>
</body>
</html>
