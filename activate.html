<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activate Product | Owlnest</title>
  <link rel="icon" type="image/png" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Manrope"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
          colors: { brand: { dark: '#455169', cream: '#faefcf', gold: '#D4AF37' } }
        }
      }
    }
  </script>
</head>

<body class="bg-brand-dark text-white min-h-screen flex flex-col font-sans relative">

  <header class="relative z-10 py-6 px-8 flex justify-center border-b border-white/5 bg-brand-dark/50 backdrop-blur-md">
    <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition">
      <img src="logo2.png" alt="Owlnest Logo" class="h-10 w-auto brightness-200 contrast-100">
      <span class="font-serif text-2xl tracking-widest font-bold">Owlnest</span>
    </a>
  </header>

  <main class="flex-grow flex items-center justify-center p-4 relative z-10">
    <div class="bg-white/5 border border-white/10 p-10 rounded-lg backdrop-blur-xl shadow-2xl w-full max-w-md text-center">
      <h2 class="text-2xl font-bold mb-4 text-brand-gold">Register Product</h2>

      <div id="loading-auth" class="text-sm opacity-70 italic">Checking login status...</div>

      <div id="main-content" class="hidden">
        <p class="mb-2 text-sm text-gray-300">Bind this product to account:</p>
        <p id="user-email" class="font-bold mb-6 text-white bg-black/20 p-2 rounded"></p>

        <input type="text" id="activate-code" readonly
          class="w-full p-3 rounded bg-black/30 border border-brand-gold/20 text-white text-center font-mono mb-6 text-sm tracking-wider">

        <button id="activate-btn" onclick="activateProduct()"
          class="w-full bg-brand-gold text-brand-dark font-bold p-3 rounded hover:bg-white transition duration-300 shadow-lg shadow-brand-gold/20 uppercase tracking-widest text-sm">
          Confirm & Activate
        </button>

        <div id="status-msg" class="text-sm font-bold mt-4 min-h-[20px]"></div>
      </div>

      <!-- ‚úÖ ‰øÆÊ≠£ÔºöÂõûÊúÉÂì°‰∏≠ÂøÉË¶ÅÂéª /account/index.html -->
      <a href="/account/index.html"
        class="block mt-8 text-xs text-gray-500 hover:text-brand-gold transition border-b border-transparent hover:border-brand-gold pb-0.5 inline-block">
        Back to Account
      </a>
    </div>
  </main>

  <footer class="relative z-10 py-8 text-center text-xs text-gray-500">
    <div class="flex justify-center items-center gap-6 mb-4">
      <a href="http://facebook.com/owlnestofficial" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-facebook-f text-lg"></i></a>
      <a href="http://www.instagram.com/owlnestpq_chilllife" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-instagram text-lg"></i></a>
      <a href="http://x.com/owlnestpq_2025" target="_blank" class="hover:text-brand-gold transition flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 fill-current" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
      </a>
    </div>
    <p>&copy; 2025 Owlnest Official. All Rights Reserved.</p>
  </footer>

  <script>
    const SUPABASE_URL = "https://khoiplqugajmybmultzs.supabase.co";
    const SUPABASE_KEY = "sb_publishable_ic3b9TeYt7SuXxLIhLuyvA_FWHYVb0Z";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const ACTIVATE_ENDPOINT = "/.netlify/functions/activate";
    let sessionToken = null;

    function $(id) { return document.getElementById(id); }

    function getKeyFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return String(params.get("key") || params.get("code") || "").trim();
    }

    async function init() {
      try {
        const key = getKeyFromUrl();

        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          sessionStorage.setItem("redirect_after_login", window.location.href);
          window.location.href = "member-login.html";
          return;
        }

        sessionToken = session.access_token;

        $("user-email").textContent = session.user.email || "";
        $("loading-auth").classList.add("hidden");
        $("main-content").classList.remove("hidden");

        if (key) {
          $("activate-code").value = key;
        } else {
          $("status-msg").textContent = "Invalid Link (Missing Key)";
          $("status-msg").className = "text-red-400 font-bold";
          $("activate-btn").disabled = true;
          $("activate-btn").classList.add("opacity-50");
        }
      } catch (e) {
        console.error("init error:", e);
        $("loading-auth").textContent = "Script error. Please check console.";
      }
    }

    async function activateProduct() {
      const key = $("activate-code").value.trim();
      const btn = $("activate-btn");
      const msg = $("status-msg");

      if (!key) return;

      btn.disabled = true;
      btn.textContent = "Activating...";
      msg.textContent = "";
      msg.className = "text-sm font-bold mt-4 min-h-[20px]";

      try {
        const response = await fetch(ACTIVATE_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${sessionToken}`
          },
          body: JSON.stringify({ key, token: key })
        });

        const data = await response.json().catch(() => ({}));

        if (response.ok && data.success) {
          msg.textContent = "üéâ Success! Product registered to your account.";
          msg.className = "text-green-400 font-bold mt-4 min-h-[20px]";
          btn.classList.add("hidden");

          // ‚úÖ ‰øÆÊ≠£ÔºöÊàêÂäüÂæåÂõû /account/index.html
          setTimeout(() => window.location.href = "/account/index.html", 1200);
          return;
        }

        const err = data.error || "unknown";
        if (err === "already_activated") msg.textContent = "‚ö†Ô∏è Product already activated.";
        else if (err === "revoked") msg.textContent = "‚ùå Product key revoked.";
        else if (err === "invalid_code") msg.textContent = "‚ùå Invalid key.";
        else if (err === "unauthorized") msg.textContent = "‚ùå Please login again.";
        else msg.textContent = `‚ùå Activation Failed (${err})`;

        msg.className = "text-red-400 font-bold mt-4 min-h-[20px]";

      } catch (err) {
        console.error(err);
        msg.textContent = "Connection Error.";
        msg.className = "text-red-400 font-bold mt-4 min-h-[20px]";
      } finally {
        if (!msg.textContent.includes("Success")) {
          btn.disabled = false;
          btn.textContent = "Confirm & Activate";
        }
      }
    }

    window.activateProduct = activateProduct;
    init();
  </script>

</body>
</html>
