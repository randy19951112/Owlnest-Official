<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password | Owlnest</title>
  <link rel="icon" type="image/png" href="logo.png" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Manrope"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'] },
          colors: { brand: { dark: '#455169', cream: '#faefcf', gold: '#D4AF37' } }
        }
      }
    }
  </script>

  <style>
    #mobile-menu { transform: translateY(-100%); transition: transform 0.3s ease-in-out; }
    #mobile-menu.open { transform: translateY(0); }
  </style>
</head>

<body class="bg-brand-cream text-brand-dark min-h-screen flex flex-col font-sans relative">
  <!-- Ambient blobs -->
  <div class="fixed top-[-10%] right-[-5%] w-[500px] h-[500px] bg-brand-gold/5 rounded-full blur-[120px] pointer-events-none z-0"></div>
  <div class="fixed bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-brand-dark/5 rounded-full blur-[120px] pointer-events-none z-0"></div>

  <!-- Header -->
  <header id="main-header" class="fixed top-0 left-0 w-full z-50 px-4 md:px-8 py-3 md:py-6 flex justify-between items-center bg-brand-dark/95 backdrop-blur-md transition-all duration-300 border-b border-white/5 shadow-sm">
    <div class="flex items-center gap-2 flex-shrink-0">
      <img src="logo2.png" alt="Owlnest Logo" class="h-8 md:h-12 w-auto contrast-100 object-contain">
      <a href="index.html" class="font-serif text-lg md:text-3xl tracking-widest font-bold text-brand-cream hover:text-brand-gold transition whitespace-nowrap">
        Owlnest <span class="hidden sm:inline">Official</span>
      </a>
    </div>

    <div class="hidden lg:flex items-center gap-8 text-sm tracking-widest uppercase font-semibold text-brand-cream">
      <a href="about.html" class="hover:text-brand-gold transition pb-1">About Us</a>
      <a href="index.html#section-3" class="hover:text-brand-gold transition pb-1">Products</a>
      <a href="index.html#section-8" class="hover:text-brand-gold transition pb-1">Contact</a>
      <a href="member-login.html" class="hover:text-brand-gold transition pb-1">Member</a>
    </div>

    <div class="flex lg:hidden items-center gap-4 flex-shrink-0">
      <button onclick="toggleMobileMenu()" class="text-2xl focus:outline-none active:scale-95 transition text-brand-cream">
        <i class="fas fa-bars" id="mobile-menu-icon"></i>
      </button>
    </div>
  </header>

  <div id="mobile-menu" class="fixed inset-0 bg-brand-dark z-40 flex flex-col justify-center items-center pt-20 lg:hidden text-brand-cream">
    <nav class="flex flex-col gap-8 text-xl tracking-widest uppercase font-semibold text-center">
      <a href="index.html" class="hover:text-brand-gold transition" onclick="toggleMobileMenu()">Home</a>
      <a href="about.html" class="hover:text-brand-gold transition" onclick="toggleMobileMenu()">About Us</a>
      <a href="index.html#section-3" class="hover:text-brand-gold transition" onclick="toggleMobileMenu()">Products</a>
      <a href="index.html#section-8" class="hover:text-brand-gold transition" onclick="toggleMobileMenu()">Contact</a>
      <a href="member-login.html" class="hover:text-brand-gold transition" onclick="toggleMobileMenu()">Member</a>
    </nav>
  </div>

  <!-- Main -->
  <main class="flex-grow flex items-center justify-center p-4 relative z-10 pt-28 md:pt-32">
    <div class="bg-brand-dark border border-white/10 p-8 md:p-12 rounded-lg shadow-2xl w-full max-w-md text-white relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-brand-gold/10 rounded-full blur-2xl pointer-events-none"></div>

      <h2 class="text-3xl font-serif mb-2 text-center text-brand-gold relative z-10">Reset Password</h2>
      <p class="mb-6 text-sm text-center text-gray-300 font-light tracking-wide relative z-10">
        Set a new password for your account.
      </p>

      <div id="message" class="mb-5 text-center text-sm hidden p-3 rounded bg-black/20 text-white"></div>

      <form id="reset-form" class="space-y-5 relative z-10">
        <div>
          <input
            type="password"
            id="newPassword"
            placeholder="New Password (min 6)"
            autocomplete="new-password"
            class="w-full p-4 rounded bg-white border border-gray-300 text-brand-dark placeholder-gray-500 focus:outline-none focus:border-brand-gold focus:ring-2 focus:ring-brand-gold/50 transition text-center tracking-wide shadow-sm"
          >
        </div>

        <div>
          <input
            type="password"
            id="confirmPassword"
            placeholder="Confirm New Password"
            autocomplete="new-password"
            class="w-full p-4 rounded bg-white border border-gray-300 text-brand-dark placeholder-gray-500 focus:outline-none focus:border-brand-gold focus:ring-2 focus:ring-brand-gold/50 transition text-center tracking-wide shadow-sm"
          >
        </div>

        <button
          type="submit"
          id="save-btn"
          class="w-full bg-brand-gold text-brand-dark font-bold py-4 rounded hover:bg-white transition duration-300 uppercase tracking-widest text-sm shadow-lg transform active:scale-95 mt-2"
        >
          Update Password
        </button>

        <div class="text-center mt-3">
          <a
            href="member-login.html"
            class="text-xs text-gray-300 hover:text-brand-gold transition border-b border-transparent hover:border-brand-gold pb-0.5 tracking-widest uppercase"
          >
            Back to Member Login
          </a>
        </div>
      </form>
    </div>
  </main>

  <!-- Footer -->
  <footer class="relative z-10 py-8 text-center text-xs text-brand-dark/50">
    <div class="flex justify-center items-center gap-6 mb-4">
      <a href="http://facebook.com/owlnestofficial" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-facebook-f text-lg"></i></a>
      <a href="http://www.instagram.com/owlnestpq_chilllife" target="_blank" class="hover:text-brand-gold transition"><i class="fab fa-instagram text-lg"></i></a>
      <a href="http://x.com/owlnestpq_2025" target="_blank" class="hover:text-brand-gold transition flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 fill-current" viewBox="0 0 512 512"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
      </a>
    </div>
    <p>&copy; 2025 Owlnest Official. All Rights Reserved.</p>
  </footer>

  <script>
    const SUPABASE_URL = 'https://khoiplqugajmybmultzs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ic3b9TeYt7SuXxLIhLuyvA_FWHYVb0Z';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('open');
    }

    const msg = document.getElementById('message');
    const form = document.getElementById('reset-form');
    const saveBtn = document.getElementById('save-btn');

    function showMessage(text, type = 'info') {
      msg.classList.remove('hidden');
      msg.className = 'mb-5 text-center text-sm p-3 rounded bg-black/20 text-white';
      if (type === 'error') msg.classList.add('text-red-300', 'border', 'border-red-500/30');
      if (type === 'ok') msg.classList.add('text-green-300', 'border', 'border-green-500/30');
      msg.innerHTML = text;
    }

    function hideMessage() {
      msg.classList.add('hidden');
      msg.innerHTML = '';
    }

    // ✅ Key point:
    // The reset link brings the user here with tokens in the URL hash.
    // Supabase client will detect it and establish a session automatically.
    async function ensureResetSession() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        showMessage(
          '❌ Link invalid or expired.<br/>Please go back and request a new reset email.',
          'error'
        );
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
        return false;
      }
      return true;
    }

    (async function init() {
      await ensureResetSession();
    })();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();

      const p1 = document.getElementById('newPassword').value;
      const p2 = document.getElementById('confirmPassword').value;

      if (!p1 || p1.length < 6) { showMessage('❌ Password too short (min 6).', 'error'); return; }
      if (p1 !== p2) { showMessage('❌ Passwords do not match.', 'error'); return; }

      const ok = await ensureResetSession();
      if (!ok) return;

      saveBtn.disabled = true;
      saveBtn.classList.add('opacity-50');
      saveBtn.textContent = 'Updating...';

      try {
        const { error } = await sb.auth.updateUser({ password: p1 });
        if (error) throw error;

        showMessage('✅ Password updated. Redirecting to login...', 'ok');
        setTimeout(() => { window.location.href = '/member-login.html'; }, 900);
      } catch (err) {
        console.error(err);
        showMessage('❌ ' + (err?.message || 'Failed to update password.'), 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50');
        saveBtn.textContent = 'Update Password';
      }
    });
  </script>
</body>
</html>
