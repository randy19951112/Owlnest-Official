<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/account.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <title>Owlnest Â· Profile</title>
</head>
<body class="page-profile">
  <div class="wrap">
    <aside class="sidebar"><div id="nav"></div></aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="text-h1">Profile</h1>
          <div class="text-sub">Manage your personal information</div>
        </div>
        <div class="topbar-actions">
           <button id="btnSave" class="btn primary">Save Changes</button>
        </div>
      </div>

      <div class="std-card content-narrow">
         <div id="msg" class="text-bold text-success min-h-20"></div>
         
         <div class="form-grid">
            <div class="form-full input-group">
               <label class="input-label">Email Address</label>
               <input type="text" id="email" class="input-field" disabled>
            </div>
            
            <div class="input-group">
               <label class="input-label">Full Name</label>
               <input type="text" id="full_name" class="input-field" placeholder="e.g. John Doe">
            </div>
            
            <div class="input-group">
               <label class="input-label">Phone Number</label>
               <input type="text" id="phone" class="input-field" placeholder="+886 912 345 678">
            </div>
            
            <div class="form-full mt-4 section-divider">
               <label class="text-h2 label-md">Shipping Address</label>
            </div>
            
            <div class="input-group">
               <label class="input-label">Country / Region</label>
               <input type="text" id="country" class="input-field">
            </div>
            <div class="input-group">
               <label class="input-label">City</label>
               <input type="text" id="city" class="input-field">
            </div>
            <div class="form-full input-group">
               <label class="input-label">Address Line 1</label>
               <input type="text" id="addr1" class="input-field">
            </div>
            <div class="form-full input-group">
               <label class="input-label">Address Line 2 (Optional)</label>
               <input type="text" id="addr2" class="input-field">
            </div>
         </div>
      </div>
      
      <div class="std-card content-narrow card-danger mt-4">
         <div class="text-bold text-danger">Security Zone</div>
         <p class="text-sub">Need to update your password?</p>
         <button id="btnReset" class="btn btn-danger w-fit">Send Password Reset Email</button>
         <div id="resetMsg" class="text-sub"></div>
      </div>

    </main>
  </div>

  <script type="module">
    import { requireUser } from "./js/authGuard.js";
    import { supabase } from "./js/supabaseClient.js";
    import { renderNav } from "./js/uiNav.js";

    renderNav("profile");

    async function init(){
      const user = await requireUser();
      if (!user) return;
      
      document.getElementById("email").value = user.email;
      
      const md = user.user_metadata || {};
      const safe = (k) => md[k] || "";
      
      document.getElementById("full_name").value = safe("full_name");
      document.getElementById("phone").value = safe("phone");
      document.getElementById("country").value = safe("country");
      document.getElementById("city").value = safe("city");
      document.getElementById("addr1").value = safe("addr1");
      document.getElementById("addr2").value = safe("addr2");
      
      document.getElementById("btnSave").onclick = async () => {
         const btn = document.getElementById("btnSave");
         btn.textContent = "Saving...";
         btn.disabled = true;
         
         const updates = {
           full_name: document.getElementById("full_name").value,
           phone: document.getElementById("phone").value,
           country: document.getElementById("country").value,
           city: document.getElementById("city").value,
           addr1: document.getElementById("addr1").value,
           addr2: document.getElementById("addr2").value,
         };
         
         const { error } = await supabase.auth.updateUser({ data: updates });
         btn.disabled = false;
         btn.textContent = "Save Changes";
         
         if(error) alert("Error: " + error.message);
         else {
           const msg = document.getElementById("msg");
           msg.textContent = "Profile updated successfully.";
           setTimeout(()=> msg.textContent="", 3000);
         }
      };
      
      document.getElementById("btnReset").onclick = async () => {
         const { error } = await supabase.auth.resetPasswordForEmail(user.email, {
           redirectTo: window.location.origin + "/member-login.html"
         });
         if(error) alert(error.message);
         else document.getElementById("resetMsg").textContent = "Check your email for the reset link.";
      };
    }
    init();
  </script>
</body>
</html>
