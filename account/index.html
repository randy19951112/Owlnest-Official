<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/account.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <title>Account · Dashboard</title>

  <style>
    /* 內卡片：讓白底卡片裡再有層級 */
    .innerCard{
      margin-top:14px;
      padding:14px 16px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.72);
    }
    .kpiRow{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .kpiNum{ font-size:54px; font-weight:950; line-height:1; color:var(--col-gold); }
    .kpiLabel{ opacity:.75; }
    .innerLine{ height:1px; background:rgba(0,0,0,.06); margin:14px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="sidebar"><div id="nav"></div></aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="h1">Dashboard</div>
          <div class="muted" id="welcome">Loading...</div>
        </div>
        <div class="actions">
          <a class="btn" href="./products.html"><i class="fas fa-box"></i> MY PRODUCTS</a>
          <a class="btn" href="./profile.html"><i class="fas fa-user"></i> PROFILE</a>
          <button class="btn" id="btnTopSignOut"><i class="fas fa-right-from-bracket"></i> SIGN OUT</button>
        </div>
      </div>

      <div class="grid">
        <!-- ✅ 改成：外卡片 + 內卡片（層級更清楚） -->
        <section class="card col-7">
          <div class="cardTitle">My Products</div>
          <div class="cardSub">Registered devices</div>

          <div class="innerCard">
            <div class="kpiRow">
              <div>
                <div class="kpiLabel">Total</div>
                <div class="kpiNum" id="count">-</div>
              </div>

              <a class="btn primary" href="../activate.html"><i class="fas fa-plus"></i> ACTIVATE NEW</a>
            </div>

            <div class="innerLine"></div>

            <div class="kpiLabel">Latest registration</div>
            <div style="margin-top:6px; font-weight:900; font-size:18px;" id="latest">-</div>
          </div>
        </section>

        <section class="card col-5">
          <div class="cardTitle">Quick Actions</div>
          <div class="cardSub">Shortcuts</div>

          <div class="row">
            <div>
              <div style="font-weight:900;"><i class="fas fa-qrcode" style="color:var(--col-gold);"></i> Verify product</div>
              <div class="small">Check authenticity before activation</div>
            </div>
            <a class="btn primary" href="../verify.html">VERIFY</a>
          </div>

          <div class="row">
            <div>
              <div style="font-weight:900;"><i class="fas fa-user-pen" style="color:var(--col-gold);"></i> Update profile</div>
              <div class="small">Name / phone / security</div>
            </div>
            <a class="btn" href="./profile.html">OPEN</a>
          </div>

          <div class="row">
            <div>
              <div style="font-weight:900;"><i class="fas fa-headset" style="color:var(--col-gold);"></i> Support</div>
              <div class="small">Warranty & Support</div>
            </div>
            <a class="btn" href="./support.html">VIEW</a>
          </div>
        </section>

        <section class="card col-12" style="background:var(--card2);">
          <div class="cardTitle">Notice</div>
          <div class="muted">
            We will never show your product key in Member Center. You will only see a display code like “Sleep Aid Lamp 48291374”.
          </div>
        </section>
      </div>
    </main>
  </div>

  <script type="module">
    import { requireUser, signOut } from "./js/authGuard.js";
    import { supabase } from "./js/supabaseClient.js";
    import { renderNav } from "./js/uiNav.js";

    renderNav("dashboard");

    function showLatest(item){
      const token = (item?.display_token ?? "").toString().trim();
      const name = token ? `Sleep Aid Lamp ${token}` : "Registered";
      const d = item?.activated_at ? new Date(item.activated_at).toLocaleDateString() : "-";
      return `${name}  (${d})`;
    }

    async function init(){
      const user = await requireUser();
      if (!user) return;

      document.getElementById("welcome").textContent = `Welcome back, ${user.email || ""}`;
      document.getElementById("btnTopSignOut").addEventListener("click", signOut);

      const { data, error } = await supabase
        .from("activations")
        .select("display_token, activated_at")
        .eq("user_id", user.id)
        .order("activated_at", { ascending:false });

      if (error){
        document.getElementById("count").textContent = "-";
        document.getElementById("latest").textContent = "Unable to load";
        return;
      }

      const items = data || [];
      document.getElementById("count").textContent = String(items.length || 0);
      document.getElementById("latest").textContent = items.length ? showLatest(items[0]) : "-";
    }

    init();
  </script>
</body>
</html>
